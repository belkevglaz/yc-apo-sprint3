# 4. Компоненты системы

Основой решения являются микросервисы, каждый из которых ответственен за свой "кусочек" общей функциональности. 
Для обеспечения связанности, безопасности и возможности масштабирования приоритетным видится использование неблокируемых
механизмов обмена данными между сервисами.

На диаграмме C4 Containers, представленной ниже, отображения основные и наиболее значимые функциональные блоки системы:  

{% include 'assets/target/ContainerDiagram.md' %}

## 4.1 Описание компонентов

Перечислим базовые блоки системы, отображенные на диаграмме с пояснениями их роли и функциональности.

* **Customer** 

    Непосредственный пользователь системы, который через web-клиент взаимодействует с системой

* **Administrator** 

    Авторизованный пользователь, имеющий право на управление и мониторинг системы.

* **API Gateway**

    Компонент, являющийся основной точкой входа в систему. Отвечает за маршрутизацию запросов к системе по её компонентам. 
    Также берет на себя роль балансировки трафика, роль безопасности (защита от DDOS-атак, Rate Limiter и т.п)

* Микросервис **User Management** 

    Сервис отвечающий за управление пользователями. Берет на себя функциональность как аутентификации пользователей, так и авторизации.

<details>
  <summary>C4 Component User Management Service Diagram</summary>
    {% include 'assets/target/UserManageCompDiagram.md' %}
</details>

* База данных **User Database**

    Обеспечивает хранение информации о пользователях, их данных и ролях, в которых состоят пользователи.

* Микросервис **Houses & Settlements management**

    Сервис для управления домами и поселками.

* База данных **Location Database**

    Обеспечивает хранение информации поселках, находящихся в них домах и всей сопутствующей инфформации. 

* Микросервис **Telemetry Handler**

    Сервис обработки событий телеметрии, поступающих от устройств (модулей и датчиков). 
    Занимается трансформацией разнородных сообщений в единый формат, обработкой мета информации в событиях и сохранение событий в шину данных (Kafka).
    Используется паттерн CQRS.

<details>
  <summary>C4 Component Telemetry Handler Service Diagram</summary>
    {% include 'assets/target/TelemetryHandlerCompDiagram.md' %}
</details>

* Микросервис **Telemetry Reports**

    Сервис ответственный за получение данных телеметрии, построение отчетов и истории. Использует паттерн CQRS.

* **Kafka**

    Основной компонент для хранения данных телеметрии. Обеспечивает возможность потоковой обработки и выборки данных. Хранение данных телеметрии с датчиков 
    реализуется на основе топиков. Это позволяет заинтересованным сервисам подписаться на заданные события для заданных устройств.

* Микросервис **Automation management**

    Сервис обеспечения функциональности автоматизации. Отвечает за хранение шаблонов сценариев, создание, управление и запуск сценариев как по событию, так и по расписанию. 
    Данный сервис подписан на события, при появлении которых и выполнении условий запускается сценарий. 

* База данных **Automation Database**

    Обеспечивает хранение данных по сценариям автоматизации.

* Микросервис **Device management**

    Сервис реализует функциональность управления модулями, а также датчиками. Может управлять как напрямую, так и через модули сопряжения, если нет возможности прямого доступа к датчику.
    Тут стоит отметить, что датчики (например температуры, влажности и т.п.) не всегда имеют прямой доступ в интернет (и доступны из-вне). Зачастую датчики подключаются посредством bluetooth/zigbee к 
    некому модулю, установленному в доме, который уже имея доступ в интернет, передает данные в систему. Таким же образом организована и обратная связь от системы через модуль к датчику.
    Также данный микросервис ответственен за регистрацию в системе новых датчиков, устанавливаемых непосредственно пользователем.

<details>
  <summary>C4 Component Device Management Service Diagram</summary>
    {% include 'assets/target/DeviceManagementCompDiagram.md' %}
</details>

* База данных **Automation Database**

    База для хранения и управления информацией о всех устройствах, модулях или датчиках, зарегистрированных в системе.

* Микросервис **Device management**

    Сервис нотификации пользователей через websocket-ы по текущим статусам и изменениям в устройства.
    Сервис подписан на получение событий от датчиков и при поступлении события отправляет уведомление подключенному пользователю

* **Датчики**

    Устройства, непосредственно собирающие определенные показатели и отправляющие их в систему. Устанавливаются в домах пользователей.

*  **Модули управления**

    Аппаратно-программные модули, установленные в домах пользователей, которые выполняют функции управления каким либо устройством в доме (котел отопления, автоматические ворота и т.д).
    Также в некоторых случаях, модуль может выступать в роли промежуточного узла, между датчиком и системой.

## 4.2 Взаимодействие компонентов

Пример схемы взаимодействия при получении события от датчика и запуска сценария.

<details>
  <summary>C4 Component Device Management Service Diagram</summary>
    {% include 'assets/target/DinamicDiagram.md' %}
</details>

